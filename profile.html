<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --bg: #f8fafc;
            --text: #1e293b;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 2rem;
            color: var(--text);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .profile-header {
            background: linear-gradient(to right, #4f46e5, #818cf8);
            padding: 2rem;
            color: white;
        }

        .info-grid {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .info-item {
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 0.75rem;
        }

        .info-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .highlight {
            color: var(--primary);
            background: #eef2ff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            font-size: 1rem;
        }

        .btn-back {
            display: inline-block;
            margin-top: 2rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-success {
            color: var(--success) !important;
            font-weight: 600;
        }

        .status-default {
            color: #334155;
            font-weight: 600;
        }

        .error-msg {
            padding: 2rem;
            color: #94a3b8;
            font-style: italic;
            text-align: center;
        }
    </style>
</head>

<body>
    <?
        // Helper to extract common fields from any matching sheet
        let commonNum = "";
        let commonSubject = "";
        if (results) {
            for (let s in results) {
                if (!commonNum && results[s]['ç·¨è™Ÿ']) commonNum = results[s]['ç·¨è™Ÿ'];
                if (!commonSubject && results[s]['ä»»æ•™ç§‘ç›®']) commonSubject = results[s]['ä»»æ•™ç§‘ç›®'];
            }
        }
    ?>
    <div class="container">
        <div class="profile-card">
            <div class="profile-header">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                    <span style="font-size: 2rem; font-weight: 600;">
                        <?= user.name ?>
                    </span>
                    <span
                        style="font-size: 1rem; background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 20px; opacity: 0.9;">
                        <?= user.email.split('@')[0] ?>
                    </span>
                    <? if (commonNum) { ?>
                    <span
                        style="font-size: 1rem; background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 20px; opacity: 0.9;">
                        <?= commonNum ?>
                    </span>
                    <? } ?>
                </div>
                <div
                    style="margin-top: 1rem; font-size: 1.1rem; border-top: 1px solid rgba(255,255,255,0.15); padding-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 1.5rem;">
                    <div>
                        <span style="opacity: 0.8; font-size: 0.9rem;">æ‰€å±¬å­¸æ ¡ï¼š</span>
                        <span style="font-weight: 500;">
                            <?= user.school || SCHOOL_NAME ?>
                        </span>
                    </div>
                    <? if (commonSubject) { ?>
                    <div>
                        <span style="opacity: 0.8; font-size: 0.9rem;">ä»»æ•™ç§‘ç›®ï¼š</span>
                        <span style="font-weight: 500;">
                            <?= commonSubject ?>
                        </span>
                    </div>
                    <? } ?>
                </div>
            </div>

            <div style="padding: 2rem;">
                <h3 style="margin-top: 0; color: #1e293b; font-size: 1.25rem; margin-bottom: 1.5rem;">
                    æŸ¥è©¢çµæœ
                </h3>

                <? if (results) { ?>
                <? for (let sheetName in results) {
                        let sheetData = results[sheetName];
                    ?>
                <div style="margin-bottom: 2rem; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                    <div
                        style="background: #f8fafc; padding: 0.75rem 1.25rem; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: var(--primary); display: flex; justify-content: space-between;">
                        <span>ğŸ“
                            <?= sheetName ?>
                        </span>
                    </div>
                    <div style="padding: 0.5rem 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding-left: 1.5rem;">é …ç›®</th>
                                    <th style="padding-right: 1.5rem;">å…§å®¹ / ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                <? for (let key in sheetData) {
                                         // ç§»é™¤å†—é¤˜æ¬„ä½ï¼šå§“åã€å¸³è™Ÿã€ç·¨è™Ÿã€ç§‘ç›®
                                         const lowKey = key.toLowerCase();
                                         if (key === "å§“å" || key === "ç·¨è™Ÿ" || key === "ä»»æ•™ç§‘ç›®" ||
                                             lowKey === "æ ¡å‹™å¸³è™Ÿ" || lowKey === "å¸³è™Ÿ" || lowKey === "id" ||
                                             String(sheetData[key]).toLowerCase() === user.email.split('@')[0].toLowerCase()) continue;
                                    ?>
                                <tr>
                                    <td style="text-align: left; padding-left: 1.5rem; color: #64748b;">
                                        <?= key ?>
                                    </td>
                                    <td style="padding-right: 1.5rem;"
                                        class="<?= String(sheetData[key]).trim() === 'å·²å®Œæˆ' || String(sheetData[key]).trim() === 'å·²ç¹³äº¤' ? 'status-success' : 'status-default' ?>">
                                        <?= sheetData[key] ?>
                                    </td>
                                </tr>
                                <? } ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <? } ?>
                <? } else { ?>
                <div class="error-msg">ç›®å‰åœ¨å„è³‡æ–™è¡¨ä¸­æŸ¥ç„¡æ‚¨çš„ç›¸é—œè³‡æ–™ã€‚</div>
                <? } ?>
            </div>
        </div>
        <script>
            /**
             * ç¶²å€å„ªåŒ–è…³æœ¬ (Google Apps Script Web App å°ˆç”¨)
             * ä½¿ç”¨å®˜æ–¹ API (google.script.history) ä¾†æ›¿æ›ç¶²å€åˆ—ä¸­çš„ OpenID åƒæ•¸
             * é€™æ¨£é‡æ–°æ•´ç†é é¢æ™‚ï¼Œç³»çµ±æœƒå¾ token è®€å–å¿«å–çš„ Sessionï¼Œé¿å…é‡è¤‡é©—è­‰å°è‡´å ±éŒ¯
             */
            (function () {
                const token = "<?!= token || '' ?>";
                if (!token) return;

                // æª¢æŸ¥ç›®å‰ç¶²å€æ˜¯å¦åŒ…å« OpenID åƒæ•¸
                const search = window.location.search || "";
                const hasOpenId = search.indexOf('openid.') !== -1;
                const hasToken = search.indexOf('token=') !== -1;

                if (hasOpenId || !hasToken) {
                    try {
                        // å„ªå…ˆä½¿ç”¨ GAS å®˜æ–¹ API (é€™æœƒçœŸæ­£æ”¹è®Šç€è¦½å™¨ç¶²å€åˆ—)
                        if (typeof google !== 'undefined' && google.script && google.script.history) {
                            google.script.history.replace(null, { "token": token }, "");
                            console.log("URL cleaned via google.script.history");
                        }
                        // å‚™æ¡ˆï¼šå‚³çµ± HTML5 æ­·å²ç´€éŒ„æ“ä½œ (åœ¨æŸäº›æ²™ç®±ç’°å¢ƒä¸‹å¯èƒ½å—é™)
                        else if (window.history && window.history.replaceState) {
                            const baseUrl = window.location.origin + window.location.pathname;
                            window.history.replaceState({}, document.title, baseUrl + "?token=" + token);
                            console.log("URL cleaned via replaceState fallback");
                        }
                    } catch (e) {
                        console.error("URL optimization failed:", e);
                    }
                }
            })();
        </script>
</body>

</html>